# 分布式消息系统

---

## 基本概念

分布式消息系统就是通过使用多个服务器或者服务器集群共同协调来接受和分发消息的消息系统。通过使用消息系统，生产者只需要将其存放到broker，而无需等到消费者消费该消息。

---

## 优缺点

分布式消息系统能够提供高吞吐量和高扩展性，解耦复杂的软件系统。但其面临的挑战是分布式系统固有的协调困难、实现复杂、成本高等问题。

---

## 应用

在以下的场景中，分布式消息系统广泛应用：

- 微服务中服务间的相互通信。

- 实时日志分析。

- 异步任务队列。

- 通知系统。

- 事件驱动系统。

---

## 设计要点

在设计分布式消息系统的时候需要满足其基本特性，此外，还需要根据系统的目标来选择实现高级特性。大致来看，基本特性包括1）RPC通信协议；2）存储系统；3）推拉模型；4）消息投放时机和对象；5）高可用。高级特性包括1）可靠投递；2）消费确认；3）顺序消息。

---

## 流行的分布式消息系统

### Kafka

Kafka的设计目标是除了提供离线数据分析，还需要提供不超过几秒延迟的实时数据分析。其特点是分布式的、可扩展的和具有高吞吐量的。它提供了与消息系统相似的API并且允许应用实时地处理日志事件。

由于传统的日志聚合器(log aggregator)存在与日志处理不匹配的特征、弱分布式环境适配度、不理想的吞吐量、不支持持久化消息的问题，而LinkedIn的需求需要解决这些问题。Kafka应运而生。

从以下描述其整体架构：

- 单个分区效率：
  
  - 简单的存储：一个分区就是一个逻辑日志，一个逻辑日志由多个最大为1GB的段组成，每个段在物理上是一个文件，文件名为其起始偏移量。
  
  - 高效传输：publisher一次可以发送多个消息。consumer可以由起始偏移量和最大大小来完成一次pull。使用操作系统的page cache，避免了重复的缓存设计并且重启进程不影响缓存。sendifle API零拷贝传输。producer可以通过gzip这类压缩技术来压缩传输数据。
  
  - 无状态的broker：已经消费的偏移量由consumer记录，使用保守的日志删除策略。保守的日志删除策略为consumer提供了rewind的副作用好处。

- 分布式协作：consumer group内部没有master 节点，避免master故障，通过使用zookeeper来完成去中心化的协作。这个协作只会发生在consumer group发生成员变化时的rebalance过程。

- 消息传递保证：Kafka提供的是at-least-once消息传递模型。对于消费者来说，在单个分区中的消息是有序的，但不能保证分区间的消息是有序的。

- 可用性：通过使用复制技术来提供高可用性。消息的读写只会发送到leader上，follower只是存储副本以便于故障恢复。

但是，Kafka存在一些不足：1）消费者组的rebalance过程导致重复消费，占用过多带宽；2）partition过多会导致性能显著下降：zookeeper压力大，broker的顺序写也会趋于随机写；3）无法弹性扩容。如果一个partition压力过大，无法通过增加broker来解决；4）扩容成本高。如果要新增broker来分担旧的partition压力，需要手动迁移，并且大量的数据传输。

### Pulsar

服务、存储分离，分段存储。高扩展性，高可用性。多级缓存。

---

## 参考

- [腾讯技术工程-分布式消息队列]((https://mp.weixin.qq.com/s/1BOriPt5j4UvwIZ3Qs8F9A)

- [腾讯技术工程-消息队列二十年](https://mp.weixin.qq.com/s/1BOriPt5j4UvwIZ3Qs8F9A) 

- [Kafka: a Distributed Messaging System for Log Processing](https://www.microsoft.com/en-us/research/wp-content/uploads/2017/09/Kafka.pdf) by Jay Kreps, Neha Narkhede, Jun Rao; NetDB workshop '11, 2011
