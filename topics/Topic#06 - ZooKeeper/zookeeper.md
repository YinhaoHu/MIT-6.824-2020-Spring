# Topic #06 - ZooKeeper

---

## 线性可串行化(Linearizability)

在一个操作历史中，并发执行的操作如同按照时间上的顺序执行。也就是说，对于一个数据项的读写操作历史，每一个读都能够看到其前面的最近的写操作发生的改变。

在设计过程中，需要考虑读请求重传的情况，具体如下：

```
C1: |---W(x,1)---|        |---W(x,2)---|
C2:                |---R(x)----*----|
---------------------------------------------> Timeline
注：
1 在一个请求中，左侧竖直线表示客户端发出请求，右侧竖直线表示客户端收到服务端的响应。
2 C2请求中的星号表示重传请求点。
```

在上述情况中，C2究竟是应该得到`x=1`的响应还是`x=2`的响应？这一个问题应该留给API的设计者决定究竟是该给客户端怎样的视图效果。这两种响应结果可以是不同顶一下的线性可串行化的。

---

## ZooKeeper

**保证**    线性写(Linearizable write)和客户端FIFO顺序(Client FIFO order)。

**存储结构**    In-memory-db, WAL, fuzzy snapshot.

**应用**    集群成员管理、分布式锁。

**组成**    Request processor, Atomic broadcast, replicate DB.

---

## 总结(Conclusion)

ZooKeeper是一个用于协调分布式系统中进程的服务。其提供了线性可串行化写和FIFO客户端请求顺序这两个保证。ZooKeeper的wait-free和宽松的一致性特点为其提供高扩展性。另外，更一般的接口也使得其应用更为广泛，能够用于实现更多的原语。

ZooKeeper的数据模型类似于Unix文件系统，是一个层次命名空间。命名空间中的结点称为znode，其有ephemeral和regular两种类型。两者都是由客户显示创建的，但前者可以被客户显示删除或者系统自动移除，而后者仅能被客户显示删除。

每一次客户端与一个服务器连接时，建立一个会话(session)。每个会话都有一个timeout，一旦客户端和服务器之间历时timeout没有通信，那么该会话被自动删除。此外，会话能够从一个服务器移动到另一个该ZooKeeper集群下的另一台服务器。

watch和sequential flag是ZooKeeper提供的两种强大机制。前者建立起一种通知，一旦被设置watch的对象发生改变，服务器会立刻通知客户。后者允许服务器为新建节点名称追加一个单调递增的值。ZooKeeper保证该值不会小于同一父结点下已创建的znode的被分配的值。

从整体上看，ZooKeeper服务由请求处理者(Request Processor)，原子广播(Atomic Broadcast)和复制数据库(Replicated Database)三个模块来完成一个写请求。由复制数据库单个模块来完成读请求。请求处理者负责将一个写请求转换成一个事务。通过计算该请求应用于系统后系统的状态，它将该请求转换成一个幂等的事务。原子广播是一个用于实现共识的机制，它保证了事务要么在ZooKeeper集群中的所有服务器上提交，要么不会再任何一台服务器上提交。ZooKeeper使用ZAB协议来实现原子广播。复制数据库就是复制在每个服务器上的数据库。

就性能而言，ZooKeeper在read-dominant工作负载下提供了相当好的QPS。
